browser.runtime.onMessage.addListener((message) => {
  if (message.action === "extractInputLabels") {
    console.log("üîç B·∫Øt ƒë·∫ßu ki·ªÉm tra input/textarea");

    const userOverrides = message.userOverrides || {};

    function isSystemField(name = "") {
      return /token|formid|_bk|_e_pos|_e_error|_hidden/i.test(name);
    }

    function getLabelText(element) {
      let current = element.closest("tr, li, div, td, th");
      while (current) {
        const texts = Array.from(current.querySelectorAll("label, span, p, th, div"))
          .filter((node) => {
            const cls = node.className || "";
            return !/(error|errMsg|formError|alert|invalid|close)/i.test(cls);
          })
          .map((node) => node.textContent?.trim())
          .filter((text) => text && text.length > 0);
        if (texts.length > 0) return texts;
        current = current.parentElement;
      }
      return ["(no label text)"];
    }

    function adjustValue(value, minlength = 0, maxlength = Infinity) {
      let finalValue = value;
      while (finalValue.length < minlength) {
        finalValue += finalValue.slice(-1);
      }
      if (finalValue.length > maxlength) {
        finalValue = finalValue.slice(0, maxlength);
      }
      return finalValue;
    }

    function detectTextPatternValue(hint, maxlength, userOverrides = {}) {
      const max = isNaN(parseInt(maxlength)) ? 1 : parseInt(maxlength);

      if (/(mail|„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ|email|e-mail|meru)/i.test(hint)) {
        return userOverrides.mail || "test@gmail.com";
      }

      if (/(tel|ÈõªË©±|phone|denwa)/i.test(hint)) {
        return userOverrides.tel || "09000000000";
      }

      if (/(zipcode|ÈÉµ‰æøÁï™Âè∑|zip|yubin)/i.test(hint)) {
        if (max === 8) return "100-0000";
        if (max === 7) return "1000000";
        if (max === 3) return "100";
        if (max === 4) return "0000";
        return "1000000";
      }

      if (/Áï™Âè∑/i.test(hint) && !/ÈõªË©±Áï™Âè∑|ÈÉµ‰æøÁï™Âè∑/.test(hint)) {
        return userOverrides.number || "8".repeat(max);
      }

      return userOverrides.other || "helloo";
    }

    function isUserInput(input) {
      const style = window.getComputedStyle(input);
      const type = input.type?.toLowerCase() || "text";
      const name = input.name || "";

      return (
        !input.disabled &&
        !input.readOnly &&
        !isSystemField(name) &&
        style.display !== "none" &&
        style.visibility !== "hidden" &&
        parseFloat(style.opacity) > 0 &&
        input.offsetParent !== null
      );
    }

    function isUserTextarea(textarea) {
      const style = window.getComputedStyle(textarea);
      const name = textarea.name || "";

      return (
        !textarea.disabled &&
        !textarea.readOnly &&
        !isSystemField(name) &&
        style.display !== "none" &&
        style.visibility !== "hidden" &&
        parseFloat(style.opacity) > 0 &&
        textarea.offsetParent !== null
      );
    }

    function processFields(inputs, textareas) {
      const userInputs = Array.from(inputs).filter((input) => {
        return isUserInput(input) && input.type.toLowerCase() !== "submit";
      });

      const userTextareas = Array.from(textareas).filter(isUserTextarea);
      const allUserFields = [...userInputs, ...userTextareas];

      if (allUserFields.length === 0) return null;

      const results = [];

      allUserFields.forEach((field) => {
        const tag = field.tagName.toLowerCase();
        const type = (field.type || (tag === "textarea" ? "textarea" : "text")).toLowerCase();

        const id = field.id?.toLowerCase() || "";
        const placeholder = field.placeholder?.toLowerCase() || "";
        const className = field.className?.toLowerCase() || "";
        const nameAttr = field.name?.toLowerCase() || "";
        const labelText = getLabelText(field).join(" / ").toLowerCase();

        // üîÑ ∆Øu ti√™n: id, placeholder, class, name ‚û§ cu·ªëi c√πng m·ªõi label
        const hint = `${id} ${placeholder} ${className} ${nameAttr} ${labelText}`;

        const maxlength = field.getAttribute("maxlength");
        const minlength = field.getAttribute("minlength");

        let value = "helloo";

        switch (type) {
          case "email":
            value = userOverrides.mail || "test@gmail.com";
            break;
          case "tel":
            value = userOverrides.tel || "09000000000";
            break;
          case "time":
            value = "11:11";
            break;
          case "number":
            value = userOverrides.number || "8";
            break;
          case "url":
            value = "http://hello.hello";
            break;
          case "textarea":
            value = userOverrides.other || "helloo";
            break;
          case "text":
          default:
            value = detectTextPatternValue(hint, maxlength, userOverrides);
        }

        const min = isNaN(parseInt(minlength)) ? 1 : parseInt(minlength);
        const max = isNaN(parseInt(maxlength)) ? Infinity : parseInt(maxlength);
        const finalValue = adjustValue(value, min, max);

        // √©p tr√¨nh duy·ªát c·∫≠p nh·∫≠t l·∫°i
        field.value = "";
        field.dispatchEvent(new Event("input", { bubbles: true }));
        field.value = finalValue;
        field.dispatchEvent(new Event("input", { bubbles: true }));
        field.dispatchEvent(new Event("change", { bubbles: true }));


        results.push({
          tag,
          id: field.id || "(no id)",
          name: field.name || "",
          class: field.className || "",
          type: field.type || tag,
          placeholder: field.placeholder || "",
          maxlength: maxlength || "",
          minlength: minlength || "",
          text: getLabelText(field).join(" / "),
        });
      });

      return results;
    }

    const mainResults = processFields(
      document.querySelectorAll("input"),
      document.querySelectorAll("textarea")
    );

    if (mainResults && mainResults.length > 0) {
      console.table(mainResults);
      return;
    }

    const iframe = document.querySelector("iframe");
    if (!iframe) {
      console.warn("‚ö†Ô∏è Kh√¥ng th·∫•y input v√† c≈©ng kh√¥ng c√≥ iframe n√†o.");
      return;
    }

    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
      if (!iframeDoc) {
        console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ truy c·∫≠p n·ªôi dung iframe.");
        return;
      }

      const iframeResults = processFields(
        iframeDoc.querySelectorAll("input"),
        iframeDoc.querySelectorAll("textarea")
      );

      if (!iframeResults || iframeResults.length === 0) {
        console.warn("‚ö†Ô∏è Kh√¥ng th·∫•y input trong iframe.");
        return;
      }

      console.log("üìã K·∫øt qu·∫£ input/textarea trong iframe:");
      console.table(iframeResults);
    } catch (e) {
      console.error("‚ùå L·ªói khi x·ª≠ l√Ω iframe:", e);
    }
  }

  if (message.action === "cleanFormFields") {
    console.log("üßπ ƒêang x√≥a to√†n b·ªô gi√° tr·ªã input v√† textarea");

    function clearFieldsFromDocument(doc) {
      const inputs = doc.querySelectorAll("input:not([type=hidden]):not([type=button]):not([type=submit])");
      const textareas = doc.querySelectorAll("textarea");

      inputs.forEach((input) => input.value = "");
      textareas.forEach((textarea) => textarea.value = "");
    }

    clearFieldsFromDocument(document);

    const iframes = document.querySelectorAll("iframe");
    iframes.forEach((iframe) => {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (iframeDoc) {
          clearFieldsFromDocument(iframeDoc);
        }
      } catch (err) {
        console.warn("Kh√¥ng th·ªÉ truy c·∫≠p iframe kh√°c origin:", err);
      }
    });
  }
});

